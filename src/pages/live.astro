---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Talk with Seth">
  <main class="live-page">
    <div class="container">
      <header>
        <h1>TALK WITH SETH</h1>
        <p>HAVE A CONVERSATION WITH AN AI VERSION OF ME</p>
      </header>

      <div class="video-container">
        <video id="avatar-video" autoplay playsinline></video>
        <div id="status" class="status">Connecting...</div>
      </div>

      <div class="controls">
        <button id="mic-btn" class="mic-btn" disabled>
          <span id="mic-icon">üé§</span>
          <span id="mic-text">CLICK TO START</span>
        </button>
      </div>

      <footer>
        <a href="/chat" class="alt-link">Prefer text? Try the chat ‚Üí</a>
        <a href="/">‚Üê BACK TO SETHGOLDSTEIN.COM</a>
      </footer>
    </div>
  </main>
</Layout>

<script>
  import { LiveAvatarSession, SessionEvent, SessionState } from '@heygen/liveavatar-web-sdk';

  const video = document.getElementById('avatar-video') as HTMLVideoElement;
  const status = document.getElementById('status') as HTMLDivElement;
  const micBtn = document.getElementById('mic-btn') as HTMLButtonElement;
  const micIcon = document.getElementById('mic-icon') as HTMLSpanElement;
  const micText = document.getElementById('mic-text') as HTMLSpanElement;

  let session: LiveAvatarSession | null = null;
  let isListening = false;
  let streamReady = false;

  function setStatus(msg: string) {
    status.textContent = msg;
    status.style.opacity = '1';
    console.log('[Live]', msg);
  }

  async function init() {
    try {
      setStatus('Getting session token...');

      const tokenRes = await fetch('/api/avatar/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customMode: false })
      });

      if (!tokenRes.ok) {
        throw new Error(`Token request failed: ${tokenRes.status}`);
      }

      const { token, sessionId } = await tokenRes.json();
      console.log('[Live] Got token, session:', sessionId);

      setStatus('Creating session...');

      // SDK constructor: (sessionAccessToken: string, config?: SessionConfig)
      session = new LiveAvatarSession(token, {
        voiceChat: true
      });

      // Listen for state changes
      session.on(SessionEvent.SESSION_STATE_CHANGED, (state: SessionState) => {
        console.log('[Live] State changed:', state);

        if (state === SessionState.CONNECTED) {
          // Try to attach if stream is already ready
          if (streamReady) {
            console.log('[Live] State CONNECTED and stream ready - attaching');
            session?.attach(video);
            video.play().catch(e => console.log('[Live] Autoplay blocked:', e));
            setStatus('Connected! Click mic to talk.');
            setTimeout(() => { status.style.opacity = '0'; }, 2000);
            micBtn.disabled = false;
          } else {
            setStatus('Connected, waiting for stream...');
          }
        } else if (state === SessionState.DISCONNECTED) {
          setStatus('Disconnected');
          micBtn.disabled = true;
        } else if (state === SessionState.CONNECTING) {
          setStatus('Connecting...');
        }
      });

      // Listen for stream ready - this fires when both video AND audio tracks are received
      session.on(SessionEvent.SESSION_STREAM_READY, () => {
        console.log('[Live] Stream ready!');
        streamReady = true;

        // Attach the stream to video element
        session?.attach(video);
        video.play().catch(e => console.log('[Live] Autoplay blocked:', e));

        // Enable controls
        setStatus('Connected! Click mic to talk.');
        setTimeout(() => { status.style.opacity = '0'; }, 2000);
        micBtn.disabled = false;
      });

      // Listen for disconnection
      session.on(SessionEvent.SESSION_DISCONNECTED, (reason) => {
        console.log('[Live] Disconnected:', reason);
        setStatus(`Disconnected: ${reason}`);
        micBtn.disabled = true;
      });

      setStatus('Starting session...');
      await session.start();
      console.log('[Live] Session start() completed');

    } catch (error) {
      console.error('[Live] Init error:', error);
      setStatus(error instanceof Error ? error.message : 'Connection failed');
    }
  }

  micBtn.addEventListener('click', async () => {
    if (!session) return;

    try {
      if (!isListening) {
        session.startListening();
        isListening = true;
        micIcon.textContent = 'üî¥';
        micText.textContent = 'LISTENING...';
        micBtn.classList.add('listening');
      } else {
        session.stopListening();
        isListening = false;
        micIcon.textContent = 'üé§';
        micText.textContent = 'CLICK TO TALK';
        micBtn.classList.remove('listening');
      }
    } catch (error) {
      console.error('[Live] Mic error:', error);
    }
  });

  init();
</script>

<style>
  .live-page {
    min-height: 100vh;
    background: var(--color-bg, #000);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-8, 2rem);
    font-family: var(--font-display, 'Helvetica Neue', Helvetica, Arial, sans-serif);
  }

  .container {
    width: 100%;
    max-width: 900px;
  }

  header {
    margin-bottom: 1.5rem;
    text-align: center;
  }

  h1 {
    font-size: var(--text-3xl, 3rem);
    font-weight: 700;
    color: var(--color-text-primary, #fff);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.5rem 0;
  }

  header p {
    font-size: var(--text-base, 1rem);
    font-weight: 500;
    color: var(--color-text-muted, #666);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0;
  }

  .video-container {
    width: 100%;
    aspect-ratio: 16/9;
    border: var(--border-width, 1px) solid var(--color-border, #333);
    background: var(--color-surface, #111);
    position: relative;
    overflow: hidden;
  }

  #avatar-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .status {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    border-radius: 4px;
    transition: opacity 0.3s;
  }

  .controls {
    margin-top: 1.5rem;
    display: flex;
    justify-content: center;
  }

  .mic-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    background: #222;
    border: 1px solid #444;
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mic-btn:hover:not(:disabled) {
    background: #333;
    border-color: #666;
  }

  .mic-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .mic-btn.listening {
    background: #400;
    border-color: #800;
  }

  footer {
    margin-top: 2rem;
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .alt-link {
    font-size: 0.75rem;
    color: #666;
    text-decoration: none;
    transition: color 0.2s;
  }

  .alt-link:hover {
    color: #fff;
  }

  footer a:not(.alt-link) {
    font-size: 0.875rem;
    font-weight: 700;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-decoration: none;
    transition: color 0.2s;
  }

  footer a:not(.alt-link):hover {
    color: #888;
  }

  @media (max-width: 768px) {
    .live-page {
      padding: 1rem;
    }

    h1 {
      font-size: 2rem;
    }

    header p {
      font-size: 0.75rem;
    }

    .mic-btn {
      padding: 0.875rem 1.5rem;
    }
  }
</style>
