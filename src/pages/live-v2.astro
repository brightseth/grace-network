---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Talk with @seth">
  <main class="live-page">
    <div class="container">
      <header>
        <h1>TALK WITH @SETH</h1>
        <p>VOICE CONVERSATION WITH MY AI AGENT</p>
        <p class="powered-by">POWERED BY LIVEAVATAR</p>
      </header>

      <div class="video-container">
        <video id="avatar-video" autoplay playsinline></video>
        <div id="status" class="status">Initializing...</div>
      </div>

      <div class="controls">
        <button id="mic-btn" class="mic-btn" disabled>
          <span class="mic-icon">üé§</span>
          <span class="mic-text">CLICK TO START</span>
        </button>
        <div id="transcript" class="transcript"></div>
      </div>

      <footer>
        <a href="/chat" class="alt-link">Prefer text? Try the chat ‚Üí</a>
        <a href="/">‚Üê BACK TO SETHGOLDSTEIN.COM</a>
      </footer>
    </div>
  </main>
</Layout>

<script>
  import { LiveAvatarSession, SessionEvent, AgentEventsEnum } from '@heygen/liveavatar-web-sdk';

  const videoEl = document.getElementById('avatar-video') as HTMLVideoElement;
  const statusEl = document.getElementById('status')!;
  const micBtn = document.getElementById('mic-btn') as HTMLButtonElement;
  const micText = micBtn.querySelector('.mic-text')!;
  const transcriptEl = document.getElementById('transcript')!;

  let session: LiveAvatarSession | null = null;
  let isVoiceChatActive = false;

  function setStatus(text: string) {
    statusEl.textContent = text;
  }

  function setTranscript(text: string, speaker: 'user' | 'seth' = 'seth') {
    transcriptEl.innerHTML = `<span class="${speaker}">${speaker === 'user' ? 'You: ' : '@seth: '}${text}</span>`;
  }

  async function initAvatar() {
    setStatus('Getting session token...');

    try {
      // Get session token from our API
      const tokenResponse = await fetch('/api/avatar/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customMode: false }),
      });

      const tokenData = await tokenResponse.json();

      if (tokenData.error) {
        throw new Error(tokenData.details || tokenData.error);
      }

      console.log('Got token, creating session...');
      setStatus('Connecting to avatar...');

      // Create LiveAvatar session
      session = new LiveAvatarSession(tokenData.token);

      // Attach video to element
      session.attach(videoEl);

      // Set up event listeners using correct SDK events
      session.on(SessionEvent.SESSION_STATE_CHANGED, (state) => {
        console.log('Session state changed:', state);
        if (state === 'connected') {
          setStatus('Connected - waiting for stream...');
        }
      });

      session.on(SessionEvent.SESSION_STREAM_READY, () => {
        console.log('Stream ready!');
        setStatus('Ready - click to start talking');
        micBtn.disabled = false;
      });

      session.on(SessionEvent.SESSION_DISCONNECTED, (reason) => {
        console.log('Session disconnected:', reason);
        setStatus('Session ended - refresh to restart');
        micBtn.disabled = true;
      });

      // User transcription events
      session.on(AgentEventsEnum.USER_TRANSCRIPTION, (event) => {
        console.log('User said:', event.text);
        setTranscript(event.text, 'user');
      });

      // Avatar transcription events
      session.on(AgentEventsEnum.AVATAR_TRANSCRIPTION, (event) => {
        console.log('@seth said:', event.text);
        setTranscript(event.text, 'seth');
      });

      // Speaking state events
      session.on(AgentEventsEnum.USER_SPEAK_STARTED, () => {
        setStatus('Listening...');
      });

      session.on(AgentEventsEnum.USER_SPEAK_ENDED, () => {
        setStatus('Thinking...');
      });

      session.on(AgentEventsEnum.AVATAR_SPEAK_STARTED, () => {
        setStatus('@seth is speaking...');
      });

      session.on(AgentEventsEnum.AVATAR_SPEAK_ENDED, () => {
        setStatus('Ready - click to speak');
      });

      // Start the session
      setStatus('Starting session...');
      await session.start();
      console.log('Session started, waiting for stream...');

    } catch (error) {
      console.error('Avatar initialization error:', error);
      setStatus(`Failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }

  // Mic button toggles voice chat
  micBtn.addEventListener('click', async () => {
    if (!session) return;

    try {
      if (!isVoiceChatActive) {
        session.startListening();
        isVoiceChatActive = true;
        micBtn.classList.add('listening');
        micText.textContent = 'LISTENING...';
        setStatus('Listening...');
      } else {
        session.stopListening();
        isVoiceChatActive = false;
        micBtn.classList.remove('listening');
        micText.textContent = 'CLICK TO SPEAK';
        setStatus('Ready - click to speak');
      }
    } catch (e) {
      console.error('Voice chat error:', e);
    }
  });

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (session) {
      session.stop();
    }
  });

  // Initialize on load
  initAvatar();
</script>

<style>
  .live-page {
    min-height: 100vh;
    background: #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .container {
    width: 100%;
    max-width: 900px;
  }

  header {
    margin-bottom: 1.5rem;
    text-align: center;
  }

  h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.5rem 0;
  }

  header p {
    font-size: 0.875rem;
    font-weight: 500;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0 0 0.25rem 0;
  }

  .powered-by {
    font-size: 0.625rem !important;
    color: #444 !important;
  }

  .video-container {
    width: 100%;
    aspect-ratio: 16/9;
    border: 1px solid #333;
    background: #111;
    position: relative;
    overflow: hidden;
  }

  #avatar-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .status {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border: 1px solid #333;
  }

  .controls {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .mic-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    background: #fff;
    color: #000;
    border: none;
    font-family: inherit;
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mic-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .mic-btn:not(:disabled):hover {
    opacity: 0.9;
  }

  .mic-btn.listening {
    background: #ff3333;
    color: #fff;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .mic-icon {
    font-size: 1.25rem;
  }

  .transcript {
    max-width: 600px;
    min-height: 2rem;
    text-align: center;
    font-size: 0.875rem;
    color: #888;
    line-height: 1.5;
  }

  .transcript .user {
    color: #fff;
  }

  .transcript .seth {
    color: #aaa;
  }

  footer {
    margin-top: 2rem;
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .alt-link {
    font-size: 0.75rem;
    color: #666;
    text-decoration: none;
    transition: color 0.2s;
  }

  .alt-link:hover {
    color: #fff;
  }

  footer a:not(.alt-link) {
    font-size: 0.875rem;
    font-weight: 700;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-decoration: none;
    transition: color 0.2s;
  }

  footer a:not(.alt-link):hover {
    color: #888;
  }

  @media (max-width: 768px) {
    .live-page {
      padding: 1rem;
    }

    h1 {
      font-size: 1.75rem;
    }

    .mic-btn {
      padding: 0.875rem 1.5rem;
    }
  }
</style>
