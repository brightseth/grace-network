---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Chat with @seth">
  <main class="chat-page">
    <div class="container">
      <header>
        <h1>CHAT WITH @SETH</h1>
        <p>TEXT-BASED CONVERSATION WITH MY AI AGENT</p>
        <a href="/live" class="video-link">Want video? Try the LiveAvatar →</a>
      </header>

      <div class="chat-container">
        <div id="messages" class="messages">
          <div class="message assistant">
            <div class="message-content">
              hey – im @seth (the electronic version)

              i've got 30 years of pattern recognition loaded up. currently running eden, launching spirit protocol, opening node berlin. been vibecoding daily since august.

              what do you want to talk about?
            </div>
          </div>
        </div>

        <form id="chat-form" class="input-area">
          <input
            type="text"
            id="message-input"
            placeholder="Type your message..."
            autocomplete="off"
          />
          <button type="submit" id="send-btn">SEND</button>
        </form>
      </div>

      <footer>
        <p class="hint">POWERED BY E-SETH ON EDEN</p>
        <a href="/">← BACK TO SETHGOLDSTEIN.COM</a>
      </footer>
    </div>
  </main>
</Layout>

<script>
  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('chat-form');
  const input = document.getElementById('message-input') as HTMLInputElement;
  const sendBtn = document.getElementById('send-btn');

  // Don't reuse old sessions - always start fresh to avoid access issues
  // Sessions are tied to API keys, so old sessions may not be accessible
  let sessionId: string | null = null;

  function addMessage(content: string, isUser: boolean) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
    msgDiv.innerHTML = `<div class="message-content">${content}</div>`;
    messagesEl?.appendChild(msgDiv);
    messagesEl?.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
  }

  function setLoading(loading: boolean) {
    if (sendBtn) {
      sendBtn.textContent = loading ? '...' : 'SEND';
      (sendBtn as HTMLButtonElement).disabled = loading;
    }
    if (input) {
      input.disabled = loading;
    }
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = input?.value.trim();
    if (!message) return;

    // Add user message
    addMessage(message, true);
    input.value = '';
    setLoading(true);

    try {
      const response = await fetch('/api/seth-chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, sessionId }),
      });

      const data = await response.json();

      if (data.error) {
        console.error('API error:', data);
        addMessage(`Error: ${data.error}${data.details ? ' - ' + data.details : ''}`, false);
      } else {
        // Update sessionId for conversation continuity within this page session
        if (data.sessionId) {
          sessionId = data.sessionId;
        }
        addMessage(data.reply || 'No response', false);
      }
    } catch (error) {
      console.error('Fetch error:', error);
      addMessage('Failed to connect to e-seth. Try again.', false);
    } finally {
      setLoading(false);
      input?.focus();
    }
  });

  // Focus input on load
  input?.focus();
</script>

<style is:global>
  .chat-page {
    min-height: 100vh;
    background: var(--color-bg, #000);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-8, 2rem);
    font-family: var(--font-display, 'Helvetica Neue', Helvetica, Arial, sans-serif);
  }

  .container {
    width: 100%;
    max-width: 800px;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 4rem);
  }

  header {
    margin-bottom: 1.5rem;
    text-align: center;
    flex-shrink: 0;
  }

  h1 {
    font-size: var(--text-2xl, 2.5rem);
    font-weight: 700;
    color: var(--color-text-primary, #fff);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.5rem 0;
  }

  header p {
    font-size: var(--text-sm, 0.875rem);
    font-weight: 500;
    color: var(--color-text-muted, #666);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0 0 0.5rem 0;
  }

  .video-link {
    font-size: var(--text-xs, 0.75rem);
    color: var(--color-text-secondary, #888);
    text-decoration: none;
    transition: color var(--transition-base, 0.2s);
  }

  .video-link:hover {
    color: var(--color-text-primary, #fff);
  }

  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    border: var(--border-width, 1px) solid var(--color-border, #333);
    background: var(--color-surface, #111);
    overflow: hidden;
  }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .message {
    max-width: 85%;
  }

  .message.user {
    align-self: flex-end;
  }

  .message.assistant {
    align-self: flex-start;
  }

  .message-content {
    padding: 1rem 1.25rem;
    font-size: 0.9375rem;
    line-height: 1.6;
    white-space: pre-wrap;
  }

  .message.user .message-content {
    background: var(--color-text-primary, #fff);
    color: var(--color-bg, #000);
  }

  .message.assistant .message-content {
    background: #222;
    color: var(--color-text-primary, #fff);
    border: var(--border-width, 1px) solid var(--color-border, #333);
  }

  .input-area {
    display: flex;
    gap: 0;
    border-top: var(--border-width, 1px) solid var(--color-border, #333);
    flex-shrink: 0;
  }

  #message-input {
    flex: 1;
    padding: var(--space-4, 1rem) 1.25rem;
    font-size: var(--text-base, 1rem);
    font-family: inherit;
    background: var(--color-bg, #000);
    color: var(--color-text-primary, #fff);
    border: none;
    outline: none;
  }

  #message-input::placeholder {
    color: var(--color-text-muted, #666);
  }

  #message-input:disabled {
    opacity: 0.5;
  }

  #send-btn {
    padding: var(--space-4, 1rem) var(--space-8, 2rem);
    font-size: var(--text-sm, 0.875rem);
    font-weight: 700;
    font-family: inherit;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--color-text-primary, #fff);
    color: var(--color-bg, #000);
    border: none;
    cursor: pointer;
    transition: opacity var(--transition-base, 0.2s);
  }

  #send-btn:hover:not(:disabled) {
    opacity: 0.8;
  }

  #send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  footer {
    margin-top: 1.5rem;
    text-align: center;
    flex-shrink: 0;
  }

  .hint {
    font-size: 0.6875rem;
    font-weight: 500;
    color: #444;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0 0 0.75rem 0;
  }

  footer a {
    font-size: 0.875rem;
    font-weight: 700;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-decoration: none;
    transition: color 0.2s;
  }

  footer a:hover {
    color: #888;
  }

  @media (max-width: 768px) {
    .chat-page {
      padding: 1rem;
    }

    .container {
      height: calc(100vh - 2rem);
    }

    h1 {
      font-size: 1.75rem;
    }

    .messages {
      padding: 1rem;
    }

    .message {
      max-width: 90%;
    }

    #send-btn {
      padding: 1rem 1.25rem;
    }
  }
</style>
